<!DOCTYPE html>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<html lang="zh-Hant">
<head>
	<meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="./static/mainCSS.css">
	<script type="text/javascript" src="/static/createElement.js"></script>
	<title>PyInstaller GUI</title>
	<script language=javascript>
		var stateApp = new Boolean(false);
		var listItem = [['主程式','iMainPath'],
						['Import', 'iImportPath_0'],
						['資料', 'iDataPath_0'],
						['資料夾', 'iFolderPath_0']];
		var mainPath = '';
		var importPathList = [];
		var dataPathList = [];
		var folderPathList = [];
		var iconPath = '';

		$(document).ready(function (){
			init();
        });

        function init(){
        	listItem.forEach(function(item) {
				createPathBlock('mainDiv', item);
        	})
        	stateApp = false;
        	document.getElementById('iOK').style.color = 'rgb(102, 106, 111)';
        }

		function btnProcess(id, action){
			idClass = id.split('_')[0];
			console.log('idClass: ' + idClass);
			clrBtn(id);
			if( idClass=='iMainPath'){
				if( action=='add' || action=='edit' ){
		        	newBtn(id, 'del');
		        	newBtn(id, 'edit');
		        	mainPath = document.getElementById(id+'_path').value;
				}else if( action=='del' ){
					startAPP(false);
					newBtn(id, 'add');
					mainPath = '';
					document.getElementById('iOK').style.color = 'rgb(102, 106, 111)';
				}
			}

			else if( idClass=='iImportPath' || idClass=='iDataPath' || idClass=='iFolderPath' ){
				var frameId = id.split('_')[0] + '_' + 0;
				var ind = id.split('_')[1];
				var pathList = [];
				pathList = getPathList(idClass);
				if( action=='add'){
		        	newBtn(id, 'del');
		        	newBtn(id, 'edit');
					pathList[pathList.length] = document.getElementById(id+'_path').value;
	        		var newId = idClass + '_' + pathList.length;
	        		console.log('newId: ' + newId);
					createPath(frameId+'_list', newId);
					createOption(frameId+'_list', newId);
					newBtn(newId, 'add');
				}else if( action=='edit' ){
		        	newBtn(id, 'del');
		        	newBtn(id, 'edit');
					pathList[ind] = document.getElementById(id+'_path').value;
				}else if( action=='del' ){
    				pathList[ind] = '';
					document.getElementById(frameId + '_list').removeChild(document.getElementById(id + '_path'));
					document.getElementById(frameId + '_list').removeChild(document.getElementById(id + '_option'));
				}
        		console.log(pathList);
        		savePathList(idClass, pathList);
			}

			else if( idClass=='iIcon' ){
				if( action=='add' || action=='edit' ){
		        	newBtn(id, 'del');
		        	newBtn(id, 'edit');
		        	iconPath = document.getElementById(id+'_path').value;
				}else if( action=='del' ){
					newBtn(id, 'add');
				}
			}
		}

		function checkPath(id, path){
			var result = new Boolean(true);
			if( path == mainPath ){
				console.log('overlapping');
				result = false;
			}

			importPathList.forEach(function(importPath) {
				if( path == importPath ){
					console.log('overlapping');
					result = false;
				}
			})

			dataPathList.forEach(function(importPath) {
				if( path == importPath ){
					console.log('overlapping');
					result = false;
				}
			})

			folderPathList.forEach(function(importPath) {
				if( path == importPath ){
					console.log('overlapping');
					result = false;
				}
			})

			return result;
		}

		function startAPP(state){
			stateApp = state;
			if( state ){
				document.getElementById('iOK').style.color = 'rgb(33, 215, 137)';
			}
		}

		function showError(msg){
			console.log(msg);
			document.getElementById('iTips').style.color = '#F00';
			document.getElementById('iTips').style.border = '5px solid #F00';
			document.getElementById('iTipsTitle').innerHTML = '錯誤';
			document.getElementById('iTipsTitle').style.color = '#F00';
			document.getElementById('iTipsTitle').style.border = '5px solid #F00';
			document.getElementById('iTipsTitle').style.borderBottom = 'none';
			switch(msg){
				case 'noMainPath':
					document.getElementById('iTips').innerHTML = '請選擇主要的程式進行轉換';
					break;

				case 'overLapping':
					document.getElementById('iTips').innerHTML = '該檔已經選擇過了, 與目前檔案重複';
					break;
			}
		}

		function editPath(id, action){
		    var xmlhttp;
		    xmlhttp=new XMLHttpRequest();
		    xmlhttp.onreadystatechange=function(){
		        if (xmlhttp.readyState==4 && xmlhttp.status==200){
					var result = JSON.parse(xmlhttp.responseText);
					if( result.path!='' ){
						console.log(id + "= " + result.path);
						if( checkPath(id, result.path) ){
							document.getElementById(id+'_path').value = result.path;
							if( id=='iMainPath' ){
								startAPP(true);
							}
							btnProcess(id, action);
						}else{
							showTips('');
							showError('overLapping');
						}
						
						if( id=='iIcon' ){
							var iconName = document.getElementById(id+'_path').value;
							iconName = iconName.split('/');
							iconName = iconName[iconName.length-1];
							console.log(iconName);
							document.getElementById('iIconPic').src = '/static/tmpForPyInstaller/' + iconName;
							btnProcess(id, action);
						}
						
			        }
		        }
		    }
		    xmlhttp.open("GET","/getPath?cmd="+id,true);
		    xmlhttp.send();
		}

		function delPath(id){
			document.getElementById(id+'_path').value = '';
			console.log('delPath');
			btnProcess(id, 'del');
		}

		function clrBtn(id){
			if( document.getElementById(id + '_option') ){
				document.getElementById(id + '_option').innerHTML = '';
			}
		}

		function newBtn(id, action){
			var btnId = id + '_' + action + 'Btn';
			var btnParent = document.getElementById(id + '_option');
			var btn = document.createElement("div");
			btn.setAttribute("id", btnId);
			btn.setAttribute("class", "cBtn");
			switch(action){
				case 'add':
					btn.innerHTML = '+';
					btn.style.color = 'rgb(33, 215, 137)';
					btn.onclick= function(){ editPath(id, action) };
					break;
				case 'del':
					btn.innerHTML = '&#10799';
					btn.style.color = 'rgb(255, 0, 0)';
					btn.onclick= function(){ delPath(id) };
					break;
				case 'edit':
					btn.innerHTML = '&#9998';
					btn.style.color = 'rgb(248, 198, 57)';
					btn.onclick= function(){ editPath(id, action) };
					break;
			}
			btnParent.appendChild(btn);
		}

		function getPathList(idClass){
			switch(idClass){
				case 'iImportPath':
					return importPathList;
				case 'iDataPath':
					return dataPathList;
				case 'iFolderPath':
					return folderPathList;
			}
		}
		function savePathList(idClass, pathList){
			switch(idClass){
				case 'iMainPath':
					importPathList = pathList;
					console.log('importPathList= '+importPathList);
					return;
				case 'iDataPath':
					dataPathList = pathList;
					console.log('dataPathList= '+dataPathList);
					return;
				case 'iFolderPath':
					folderPathList = pathList;
					console.log('folderPathList= '+folderPathList);
					return;
			}
		}

		function showTips(id){
			idClass = id.split('_')[0];
			console.log('idClass from Tips: ' + idClass);

			document.getElementById('iTips').style.color = ' rgb(248, 198, 57)';
			document.getElementById('iTips').style.border = '5px solid  rgb(248, 198, 57)';
			document.getElementById('iTipsTitle').innerHTML = '小提示';
			document.getElementById('iTipsTitle').style.color = ' rgb(248, 198, 57)';
			document.getElementById('iTipsTitle').style.border = '5px solid  rgb(248, 198, 57)';
			document.getElementById('iTipsTitle').style.borderBottom = 'none';

			var tips = '';
			switch(idClass){
				case 'iMainPath':
					tips = '請選擇主要的程式進行轉換';
					break;
				case 'iImportPath':
					tips = '請選擇程式中Import的其他模組, 例如自行撰寫或是轉換程式找不到路徑的模組';
					break;
				case 'iDataPath':
					tips = '請選擇須一起打包至程式資料夾的檔案, 本程式會將這些檔案複製至輸出資料夾中, 例如: 圖片、音效、文字檔等等';
					break;
				case 'iFolderPath':
					tips = '請選擇須一起打包至程式資料夾的資料夾, 本程式會將資料夾連同其內的檔案一併複製至輸出資料夾中';
					break;
				case 'iAdvanced':
					tips = '進階設定';
					break;
			}
			document.getElementById('iTipsFrame').classList.remove('hideTranslate');
			document.getElementById('iTipsFrame').style.display = 'inline-block';
			document.getElementById('iTips').innerHTML = tips;
		}

		function hideTips(){
			document.getElementById('iTipsFrame').classList.add('hideTranslate');
		}

		function submit(){
			if( stateApp ){
				var allData = {
					fileName: '',
					folderName: '',
					optionList: [],
					mainPath: mainPath,
					importPathList: importPathList,
					dataPathList: dataPathList,
					folderPathList: folderPathList,
					iconPath: iconPath
				}
				allData.fileName = document.getElementById('iFileName').value;
				allData.folderName = document.getElementById('iFolderName').value;
				allData.optionList.push($("[name='oneFile']:checked").val());
				allData.optionList.push($("[name='clean']:checked").val());
				allData.optionList.push($("[name='command']:checked").val());
				var jsonToPC = JSON.stringify(allData);
				console.log(jsonToPC);

			    var xmlhttp;
			    xmlhttp=new XMLHttpRequest();
			    xmlhttp.onreadystatechange=function(){
			        if (xmlhttp.readyState==4 && xmlhttp.status==200){}
			    }
			    xmlhttp.open("GET","/submit?data="+jsonToPC,true);
			    xmlhttp.send();
			}else{
				showTips('');
				showError('noMainPath');
			}
		}
	</script>
</head>

<body class="cBody">
<center>
	<div id='iTipsFrame' class='cTipsFrame'>
		<div id='iTipsTitle' class='cTipsTitle'>Tips</div>
		<div id='iTips' class='cTips'>Tips</div>
	</div>

	<div class="cMain" style="width:650px;">
		<div id='mainDiv' class="cBorder">
			<div class='cTitle'>PyInstaller GUI</div>
			<hr style="size:5px;width:95%;border-color:rgb(209, 223, 225);" >
		</div>

		<div class='cPathBlock cBorder' onmouseover="showTips('iAdvanced')" onmouseleave="hideTips()">
			<div class="cItem cBorder">進階設定</div>
			<div id='iAdvanced_list' class='cListBlock cBorder'>
				<div class="cInfoInput cBorder" style='height:270px;width:95%;text-align:left;padding-top:15px' id="iAdvanced_path">
					<div class="cAdvanced cBorder">&#11033&nbsp 資料夾名稱</div>
					<div class="cAdvanced cAdvancedAlignLeft cBorder" style="width:250px">
						<input class='cAdvancedInput cBorder' type='text' id='iFolderName' placeholder="預設:PyInstaller"/>
					</div>

					<div class="cAdvanced cBorder">&#11033&nbsp 執行檔名稱</div>
					<div class="cAdvanced cAdvancedAlignLeft cBorder" style="width:250px">
						<input class='cAdvancedInput cBorder' type='text' id='iFileName' placeholder="預設與原檔名一樣"/>
					</div>

					<div class="cAdvanced cBorder">&#11033&nbsp 自訂 icon:</div>
					<div class="cAdvanced cAdvancedAlignLeft cBorder" style="width:250px">
						<img id='iIconPic' src="/static/pythonIcon.png" border="" style="height:25px;width:25px;vertical-align:middle;" />
						<input class='cAdvancedInput cBorder' style='width:125px' dir='rtl' type='text' id='iIcon_path'/>
						<div id='iIcon_option' class='cOptionDiv cBorder' style='width:auto'>
							<div id='iIcon_addBtn' class="cBtn" style="font-weight:bolder" onclick="editPath('iIcon', 'add')">+</div>
						</div>
					</div>

					<div class="cAdvanced cBorder">&#11033&nbsp 生成單一執行檔</div>
					<div class="cAdvanced cAdvancedAlignLeft cBorder" style="width:250px">
						<input type="radio" name="oneFile" value='-F' checked="true"/>是
						<input type="radio" name="oneFile" value='' />否</div>

					<div class="cAdvanced cBorder">&#11033&nbsp 清除前次生成檔</div>
					<div class="cAdvanced cAdvancedAlignLeft cBorder" style="width:250px">
						<input type="radio" name="clean" value='--clean' checked="true"/>是
						<input type="radio" name="clean" value='' />否</div>

					<div class="cAdvanced cBorder">&#11033&nbsp 顯示命令視窗</div>
					<div class="cAdvanced cAdvancedAlignLeft cBorder" style="width:250px">
						<input type="radio" name="command" value='-c' checked="true"/>是
						<input type="radio" name="command" value='-w' />否</div>

				</div>
				<div id='iMainPath_option' class='cOptionDiv cBorder' style="width:0%"></div>
			</div>
		</div>

		<div class="cBorder" style="width:95%;margin:25px 0px;">
			<div id='iOK' class="cOK" onclick="submit()" onmouseleave="hideTips()">&#9658</div>
		</div>
	</div>

	<hr style="size:5px;width:80%;border-color:rgb(49, 51, 53);">
	<div class="cAbout" style="width:1500px;vertical-align:middle">
		<img src="/static/flag.png" style="width:20px;height:15px">
		<div class="cAbout">Author: Edward Chou</div>
		<div class="cAbout">
			<a href="mailto:TripleC.Light@gmail.com" style="text-decoration:none;"><img src="/static/Gmail.png" style="width:20px;height:15px"></a>
		</div>
		<div class="cAbout">
			<a href="https://triplec-light.000webhostapp.com" style="text-decoration:none;"><img src="/static/Web.png" style="width:20px;height:20px"></a>
		</div>
		<div class="cAbout">
			<a href="https://www.linkedin.com/in/edward-chou-42058912a" style="text-decoration:none;"><img src="/static/LinkedIn.png" style="width:20px;height:20px"></a>
		</div>
		<div class="cAbout">
			<a href="https://github.com/TripleC-Light" style="text-decoration:none;"><img src="/static/GitHub.png" style="width:20px;height:20px"></a>
		</div>
		
	</div>
</center>
</body>
</html>
